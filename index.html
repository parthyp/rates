<script>
    // This is the middleman that fixes the CORS error
    const proxy = "https://corsproxy.io/?url=";
    
    // Your exact dates
    const today = "2026-01-19";
    const tomorrow = "2026-01-20";
    let hotelMap = {};

    async function syncHotels() {
        const locKey = document.getElementById('locKey').value;
        const dropdown = document.getElementById('hotelDropdown');
        
        // Wrap the Xotelo URL inside the proxy URL
        const targetUrl = `https://data.xotelo.com/api/list?location_key=${locKey}`;
        const finalUrl = proxy + encodeURIComponent(targetUrl);

        try {
            const response = await fetch(finalUrl);
            const data = await response.json();
            
            if(data.result && data.result.hotels) {
                dropdown.innerHTML = '<option value="">-- Choose Hotel --</option>';
                data.result.hotels.forEach(h => {
                    hotelMap[h.hotel_key] = h.name;
                    let opt = document.createElement('option');
                    opt.value = h.hotel_key;
                    opt.innerText = h.name;
                    dropdown.appendChild(opt);
                });
                dropdown.disabled = false;
                document.getElementById('status').innerText = "âœ“ Hotels Loaded";
            }
        } catch (e) {
            document.getElementById('status').innerText = "Sync Error. Try again.";
            console.error(e);
        }
    }

    async function executeRates() {
        const hotelKey = document.getElementById('hotelDropdown').value;
        const rateList = document.getElementById('rateList');
        if(!hotelKey) return;

        rateList.innerHTML = "Fetching Booking.com rates...";

        const targetUrl = `https://data.xotelo.com/api/rates?hotel_key=${hotelKey}&chk_in=${today}&chk_out=${tomorrow}`;
        const finalUrl = proxy + encodeURIComponent(targetUrl);

        try {
            const response = await fetch(finalUrl);
            const data = await response.json();
            rateList.innerHTML = "";

            if (data.result && data.result.rates) {
                // Look only for Booking.com
                const bookingRate = data.result.rates.find(r => r.site_name === "Booking.com");
                
                if (bookingRate) {
                    rateList.innerHTML = `
                        <div style="font-size:1.2rem; font-weight:bold;">
                            ${hotelMap[hotelKey]}: <span style="color:#008009;">$${bookingRate.rate}</span>
                        </div>
                    `;
                } else {
                    rateList.innerHTML = "No Booking.com rate found for this hotel.";
                }
            }
        } catch (e) {
            rateList.innerHTML = "Error loading rates.";
        }
    }
</script>